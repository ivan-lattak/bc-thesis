{% extends 'base.html' %}
{% load static %}

{% block title %}Cvičenie č. {{ exercise_id }}{% endblock %}

{% block stylesheet %}{% static 'refactoring/style/detail.css' %}{% endblock %}

{% block content %}
<section>
    <h1>Refaktorizačné cvičenie č. {{ exercise_id }}</h1>
    {{ exercise_text|linebreaks }}
</section>

<form action="{% url 'sessions' exercise_id %}">
<p>
Práve vybraný session č.: <strong>{{ session.id }}</strong>
<button>Zmeniť</button>
</p>
</form>

<form action="{% url 'solutions' exercise_id %}">
<button{% if not selected_solution %} disabled{% endif %}>Vybrať iné riešenie</button>
</form>

<form method="post" id="refactoring_form">
{% csrf_token %}
{{ form }}
<div id="code_editor" class="editor"></div>
<div id="tests_editor" class="editor"></div>
<br>
<input type="submit" name="compileandrun" value="Compile and Run">
</form>

{% if output is not None %}
<section id="output">
<p>{{ output|linebreaksbr }}</p>
</section>
{% endif %}

<!-- Configure ACE editors -->
<script>
var codeTA = $('#{{ form.code.auto_id }}');
var testsTA = $('#{{ form.tests.auto_id }}');

codeTA.css('display', 'none');
testsTA.css('display', 'none');
</script>
<script src="{% static 'ace/ace.js' %}" charset="utf-8"></script>
<script>
var codeEditor = ace.edit('code_editor');
codeEditor.setTheme('ace/theme/xcode');
codeEditor.getSession().setMode('ace/mode/c_cpp');
codeEditor.setValue(codeTA.val());
codeEditor.gotoLine(0, 0);

var testsEditor = ace.edit('tests_editor');
testsEditor.setTheme('ace/theme/xcode');
testsEditor.getSession().setMode('ace/mode/c_cpp');
testsEditor.setValue(testsTA.val());
testsEditor.gotoLine(0, 0);

$('#refactoring_form').submit(function() {
    codeTA.val(codeEditor.getValue());
    testsTA.val(testsEditor.getValue());
    return true;
});
</script>

<!-- Colorize and format output -->
<script>
jQuery.fn.colorize = function(regex, color) {
    this.html(
        this.html()
            .replace(regex, "<span style=\"color: " + color + ";\">$&</span>")
    );
};

var RED = '#f00';
var GREEN = '#0f0';
var GREY = '#aaa';

if ($('#output').length) {
    var output = $('#output');
    output.colorize(/SUCCESS/, GREEN);
    output.colorize(/\[=+\]/g, GREEN);
    output.colorize(/\[-+\]/g, GREEN);
    output.colorize(/\[\s*RUN\s*\]/g, GREEN);
    output.colorize(/\[\s*OK\s*\]/g, GREEN);
    output.colorize(/\[\s*PASSED\s*\]/g, GREEN);

    output.colorize(/ERROR/, RED);
    output.colorize(/\[\s*FAILED\s*\]/g, RED);

    output.colorize(/----- BEGIN OUTPUT -----/, GREY);
    output.colorize(/----- END OUTPUT -----/, GREY);
    output.colorize(/----- TIME LIMIT EXCEEDED -----/, GREY);

    output.html(
        output.html().replace(/\[[^\]]*\]/g, function(match) {
            return match.replace(/\s/g, '&nbsp;');
        })
    );
}
</script>
{% endblock %}
